import os
import pandas as pd
from PyPDF2 import PdfReader

# Directory paths
file_directory = "path_to_excel_directory"
pdf_file_directory = "path_to_pdf_directory"
output_folder = "path_to_output_folder"

# Lists to store folio numbers and company names
folio_numbers = []
company_names = []

# Define a function to extract folio number using patterns
def folio_number(text, patterns):
    import re
    for pattern in patterns:
        match = re.search(pattern, text)
        if match:
            return match.group(0)
    return None

# Define patterns to identify folio numbers (example pattern)
patterns = [r'\d{8}/\d{2}']

# Step 1: Extract Folio Numbers and Company Names from PDF files
for k in os.listdir(pdf_file_directory):
    pdf_path = os.path.join(pdf_file_directory, k)
    
    reader = PdfReader(pdf_path)
    page = reader.pages[0]
    text = page.extract_text()
    
    # Extract Folio Number
    folio1 = folio_number(text, patterns)
    folio_numbers.append(folio1)
    
    # Extract Company Name
    a = text.split('In')
    c = a[0:10]
    if len(c) > 3:
        company_names.append(c[3])
    else:
        company_names.append(None)

# Step 2: Process Excel Files and add the extracted Folio Number and Company Name
for index, i in enumerate(os.listdir(file_directory)):
    x1_path = os.path.join(file_directory, i)
    print(f"Processing file: {x1_path}")
    
    # Construct CSV filename
    csv_filename = f"{os.path.splitext(i)[0]}.csv"
    csv_path = os.path.join(output_folder, csv_filename)
    
    if x1_path.endswith("xlsx"):
        xls = pd.ExcelFile(x1_path)
        all_groups = []
        all_tran = []
        
        for sheet_name in xls.sheet_names:
            print(f"Processing sheet: {sheet_name}")
            df = pd.read_excel(xls, sheet_name=sheet_name, header=1)
            df_list = df.values.tolist()
            
            for j in df_list[0:2]:
                # Processing each row (adjust as needed)
                s = str(j)
                vector1 = text_to_vector(predefined_string)
                vector2 = text_to_vector(s)
                cosine = get_cosine(vector1, vector2)
                
                if cosine > 0.07:
                    q = df_list.remove(j)
                    v = process_exit(q)
                    z = filter_digit_starting_items(v)
                    removed_items = process_exit_load(z)
                    b2 = cleaned_data(removed_items)
                    u = transaction_type(removed_items)
                    all_tran.extend(u)
                    
                    m = v[0][0]
                    if m[:1].isdigit():
                        start_position = 2
                        groups = create_groups(b2, start_position)
                    else:
                        start_position = 0
                        groups = create_groups(b2, start_position)
                    
                    all_groups.extend(groups)
        
        # Creating DataFrame
        df = pd.DataFrame(all_groups)
        df.columns = ['Amount (INR)', 'NAV(INR)', 'Price (INR)', 'No_of_Unit', 'Balance_Unit', 'Date']
        df['Transaction Type'] = pd.Series(all_tran)
        
        # Add Company Name and Folio Number columns from extracted PDF data
        df['Company Name'] = company_names[index]  # Assign corresponding company name
        df['Folio Number'] = folio_numbers[index]  # Assign corresponding folio number
        
        # Save to CSV
        df.to_csv(csv_path, index=False)
        print(f"Saved CSV: {csv_path}")
